/**
 * 
 */
package org.db;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import org.bean.User;
import org.omg.CORBA.portable.ApplicationException;


/**
 * @author maurizio
 *
 */
public class UserDBManager {

	protected static Connection con ;
	
	public static void openConnection () throws Exception {
//		System.out.println("CARICARE DRIVER PER CONNESSIONE");
	    //CARICARE DRIVER PER CONNESSIONE
        String driver = "com.mysql.jdbc.Driver";
	    Class.forName(driver);
	    //DEFINISCO url, username e password
//	    System.out.println("//DEFINISCO url, username e password");
	    String url = "jdbc:mysql://localhost:3306/testdb";
	    String username = "root" ;
	    String password = "chidan" ;
        //stabilisco la connessione
		con = DriverManager.getConnection (url, username, password);
	}
	
	public static void closeConnection () throws Exception {
		try {			
			con.close();
			System.out.println("Chiusa connessione con il database....");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	public static List<User> getUsers () {
		List<User> users = new ArrayList<User>();
		
		try {
			openConnection () ;		    
			//creo oggetto statement
			Statement cmd = con.createStatement ();
			//creo la query string
			String query = "SELECT * FROM users;";
			//interrogo il db e ottendo il risultato
			ResultSet res = cmd.executeQuery(query);
			User appoUser ;
			while (res.next()) {
				appoUser = new User () ;
				appoUser.setId(res.getLong(1));
				appoUser.setEmail(res.getString("email"));
				appoUser.setPassword(res.getString("password"));
				appoUser.setFirstname(res.getString("firstname"));
				appoUser.setLastname(res.getString("lastname"));
				appoUser.setBorndate(res.getString("borndate"));
				appoUser.setRegdate(res.getString("regdate"));
				appoUser.setRole(res.getInt("role"));
				System.out.println(res.getString(1));
				System.out.println(res.getString(2));
				users.add(appoUser);
			}
			res.close();
			closeConnection () ;
			System.out.println("users.size(): " + users.size());
		} catch (Exception e) {			
			System.out.println(e.getMessage());
			e.printStackTrace();
		}

		return users ;
	}
	
	
	
	
	public static User getUserById (int id) {
		
		User appoUser = new User();
		
		
		try {
			
			openConnection () ;		    
			//creo oggetto statement
			
			
			
			//creo la query string
			
			String query = "SELECT * FROM users WHERE id = ?;";
			
			//interrogo il db e ottendo il risultato
			
			PreparedStatement cmd = con.prepareStatement(query);
			
			cmd.setInt(1, id);
			
     		ResultSet res = cmd.executeQuery();
     		res.last();
     		System.out.println("row number: " + res.getRow());
     		res.beforeFirst();
			
			
		while (res.next()) {
				
				appoUser = new User ();
				appoUser.setId(res.getLong(1));
				appoUser.setEmail(res.getString("email"));
				appoUser.setPassword(res.getString("password"));
				appoUser.setFirstname(res.getString("firstname"));
				appoUser.setLastname(res.getString("lastname"));
				appoUser.setBorndate(res.getString("borndate"));
				appoUser.setRegdate(res.getString("regdate"));
				appoUser.setRole(res.getInt("role"));
				System.out.println(res.getString(1));
				System.out.println(res.getString(2));
				
			}
			
			res.close();
			closeConnection () ;
			
		} catch (Exception e) {			
			System.out.println(e.getMessage());
			e.printStackTrace();
		}
		return appoUser;

		
	}
	
	 public static int updateuserById (int id, String email, String password, String firstName, String lastName, String bornDate) {
		 
		 int rows = 0;
		 
		 
		 
		 try {
			 
			 openConnection();
			 
			 String query = "UPDATE users SET email = ?, password = ?, firstname = ?, lastname = ?, borndate = ? WHERE ID = ?";
		 
		 PreparedStatement cmd = con.prepareStatement(query);
			 
			 cmd.setString (1, email);
			 cmd.setString (2, password);
			 cmd.setString (3, firstName);
			 cmd.setString (4, lastName);
			 cmd.setString (5, bornDate);
			 cmd.setInt (6, id);
			  
			 rows = cmd.executeUpdate();
			 
			 System.out.println("hai aggiornato l'utente con id " + id);
			 
			
			 
			 
			closeConnection () ;
		 }catch (Exception e) {			
				System.out.println(e.getMessage());
				e.printStackTrace();
		
		 
			 


		 }
		return rows;
		 
		 
		 
		 
		 
		 
		 
}
	
	
	public static int deleteUserById (int id) {
		
		int rows = 0;
		
		try {
			
			openConnection () ;
			
			//creo oggetto statement
			
	
				
		    String query = "delete from users where id = ?;";
			
			
			PreparedStatement cmd = con.prepareStatement(query);
			cmd.setInt(1, id);
			
			//interrogo il db e ottendo il risultato
			
			rows = cmd.executeUpdate();			
			
			
			closeConnection () ;
			System.out.println("Deleted rows: " + rows);
			System.out.println("Hai cancellato l'utente con id " + id);
		} catch (Exception e) {			
			System.out.println(e.getMessage());
			e.printStackTrace();
		}

		return rows ;
	}
		 
		 
		 
	
}
	
	


